<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Phishing Email Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        // Make highScore a window property so it's globally accessible
        window.highScore = parseInt(localStorage.getItem('phishcraftHighScore')) || 0;

        // Your web app's Firebase configuration - HARDCODED
        const firebaseConfig = {
            apiKey: "AIzaSyBXvF41cPghq_5oRURD3lePBEb9NFm_mDI",
            authDomain: "phishcraft-d6a12.firebaseapp.com",
            projectId: "phishcraft-d6a12",
            storageBucket: "phishcraft-d6a12.firebasestorage.app",
            messagingSenderId: "784034453473",
            appId: "1:784034453473:web:841ca0d15d5215346464a0"
        };

        // Use projectId from your firebaseConfig as the appId for Firestore paths
        const appId = firebaseConfig.projectId;

        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Sign in anonymously
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                    console.log("Firebase: User is signed in:", user.uid);
                } else {
                    console.log("Firebase: No user is signed in. Attempting anonymous sign-in.");
                    try {
                        // Directly attempt anonymous sign-in
                        await signInAnonymously(window.auth);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Firebase: Signed in anonymously:", window.currentUserId);
                    } catch (error) {
                        console.error("Firebase Auth Error during anonymous sign-in:", error);
                    }
                }
                // Ensure high score is updated in Firebase after auth is ready
                // Pass currentMode to updateHighScoreInFirestore
                window.updateHighScoreInFirestore(window.currentMode);
            });
        } else {
            console.warn("Firebase config not found. Firebase features will be disabled.");
        }

        // Function to update high score in Firestore
        // Added 'mode' parameter to track which game mode the score came from
        window.updateHighScoreInFirestore = async (mode) => {
            if (window.db && window.currentUserId && window.highScore > 0) {
                try {
                    // Store in a public collection for admin viewing
                    const publicScoresRef = doc(window.db, `artifacts/${appId}/public/data/high_scores_public`, window.currentUserId);
                    await setDoc(publicScoresRef, {
                        userId: window.currentUserId,
                        highScore: window.highScore,
                        gameMode: mode, // Store the game mode
                        lastUpdated: new Date().toISOString()
                    }, { merge: true }); // Use merge to update existing document

                    console.log("High score updated in Firestore for user:", window.currentUserId, "Score:", window.highScore, "Mode:", mode);
                } catch (e) {
                    console.error("Error updating high score in Firestore:", e);
                }
            }
        };

        // Function to fetch all user scores for admin
        window.fetchAllUserScores = async () => {
            if (!window.db) {
                console.error("Firestore not initialized.");
                return [];
            }
            try {
                const publicScoresCollectionRef = collection(window.db, `artifacts/${appId}/public/data/high_scores_public`);
                const querySnapshot = await getDocs(publicScoresCollectionRef);
                const scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                console.log("Fetched all user scores:", scores);
                return scores;
            } catch (e) {
                console.error("Error fetching all user scores from Firestore:", e);
                return [];
            }
        };
    </script>
    <style>
        /* Custom styles for Dark Mode with Aesthetic Enhancements (Black, Red, Grey Theme) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #212322; /* Carbon */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top for better mobile scrolling */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #D0D3D4; /* Concrete */
        }
        .container {
            background-color: #2a2a2a; /* Slightly lighter dark for main content, adjusted to fit theme */
            border-radius: 18px; /* Slightly more rounded corners */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); /* Deeper, softer shadow */
            max-width: 1200px;
            width: 100%;
            padding: 40px; /* Increased padding */
            display: flex;
            flex-direction: column;
            gap: 30px; /* Increased gap for better spacing */
            position: relative; /* For modal positioning */
        }

        /* Mode Switcher Button Styling */
        .mode-switcher-btn {
            padding: 12px 25px; /* Larger padding for easier tapping */
            border-radius: 12px; /* Rounded corners */
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Subtle shadow */
            background-color: #333; /* Default background - dark grey */
            color: #D0D3D4; /* Concrete */
            border: none;
            cursor: pointer;
        }
        .mode-switcher-btn.active {
            background-color: #AB2328; /* Bright Red */
            color: white;
            box-shadow: 0 6px 20px rgba(171, 35, 40, 0.4); /* Bright Red shadow */
            transform: translateY(-2px); /* Slight lift */
        }
        .mode-switcher-btn:hover:not(.active) {
            background-color: #76232F; /* Cherry on hover */
            transform: translateY(-1px);
        }

        /* General Button Styling */
        .btn-primary {
            background-color: #AB2328; /* Bright Red */
            color: white;
            padding: 12px 25px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #76232F; /* Cherry on hover */
            transform: translateY(-1px);
        }

        /* Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.7); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal.show {
            display: flex; /* Show when active */
        }
        .modal-content {
            background-color: #2a2a2a; /* Darker background for modal content */
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%; /* Responsive width */
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh; /* Limit height for mobile */
            overflow-y: auto; /* Scroll if content overflows */
        }
        .close-button {
            color: #D0D3D4; /* Concrete */
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Keyframe for fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .container {
                padding: 20px; /* Reduce padding on smaller screens */
                gap: 20px;
            }
            .mode-switcher-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .btn-primary {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .modal-content {
                width: 95%; /* Wider on very small screens */
                padding: 20px;
            }
            .email-preview-content {
                font-size: 0.875rem; /* Smaller font for email preview */
            }
            /* Ensure options stack vertically on small screens */
            .email-part-options {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Specific styling for email preview content */
        .email-preview-content {
            background-color: #212322; /* Carbon */
            border-radius: 10px;
            padding: 25px;
            min-height: 200px;
            border: 1px solid #333; /* Adjusted border color */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto; /* Enable scrolling for long emails */
            max-height: 400px; /* Limit height */
        }

        /* Styling for the high score display */
        #highScoreDisplay {
            font-size: 1.5rem;
            font-weight: bold;
            color: #D0D3D4; /* Concrete */
            text-shadow: 0 0 8px rgba(208, 211, 212, 0.4); /* Concrete shadow */
        }

        /* Styling for selected options in build mode */
        .email-part-option.selected {
            border: 2px solid #AB2328; /* Bright Red border for selected */
            box-shadow: 0 0 15px rgba(171, 35, 40, 0.5); /* Bright Red shadow */
            transform: translateY(-2px);
        }

        /* Styling for clickable elements in spot mode */
        .email-preview-content.spot-mode span.clickable-phish-element,
        .email-preview-content.spot-mode a.clickable-phish-element { /* Added 'a' for links */
            cursor: pointer;
            border-bottom: 2px dashed #AB2328; /* Bright Red dashed underline */
            transition: background-color 0.2s ease;
        }

        .email-preview-content.spot-mode span.clickable-phish-element:hover,
        .email-preview-content.spot-mode a.clickable-phish-element:hover { /* Added 'a' for links */
            background-color: rgba(171, 35, 40, 0.2); /* Light Bright Red highlight on hover */
        }

        .email-preview-content.spot-mode span.clickable-phish-element.identified,
        .email-preview-content.spot-mode a.clickable-phish-element.identified { /* Added 'a' for links */
            background-color: rgba(208, 211, 212, 0.3); /* Concrete highlight when identified */
            border-bottom: 2px solid #D0D3D4; /* Solid Concrete underline */
            cursor: default; /* No longer clickable */
        }

        /* Hide specific elements in spot mode */
        .spot-mode-hidden {
            display: none !important;
        }

        /* Desktop specific grid for email options */
        .email-part-options {
            display: flex; /* Default to flex for mobile */
            flex-direction: column; /* Default to column for mobile */
            gap: 15px;
        }

        /* Adjust the main emailBuilder grid for desktop */
        @media (min-width: 1024px) { /* Apply for large desktop screens */
            #emailBuilder {
                grid-template-columns: repeat(4, minmax(200px, 1fr)); /* 4 columns for categories */
                gap: 20px; /* Adjust gap between category columns */
            }
        }

        @media (min-width: 769px) and (max-width: 1023px) { /* For medium desktop screens */
            #emailBuilder {
                grid-template-columns: repeat(2, minmax(250px, 1fr)); /* 2 columns for categories */
                gap: 20px;
            }
        }


        @media (min-width: 769px) { /* Apply for desktop and larger */
            .email-part-options {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Even smaller min-width for options */
                gap: 10px; /* Reduced gap */
                justify-content: center; /* Center the grid items if they don't fill the row */
            }
            .email-part-option {
                max-width: 180px; /* Reduced max-width for individual buttons */
                width: 100%; /* Ensure they still take available width up to max-width */
                margin: 0 auto; /* Center buttons within their grid cells */
                padding: 8px 12px; /* Further reduced padding */
                font-size: 0.85rem; /* Further smaller font size */
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="container bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-10 lg:p-12">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-AB2328 mb-6">PhishCraft</h1>

        <!-- Mode Switcher -->
        <div class="flex justify-center gap-4 mb-8">
            <button id="buildModeBtn" class="mode-switcher-btn active">Build Your Phish</button>
            <button id="spotModeBtn" class="mode-switcher-btn">Spot the Phish</button>
        </div>

        <!-- High Score Display -->
        <div class="text-center mb-6">
            <p class="text-lg text-D0D3D4">High Score: <span id="highScoreDisplay" class="text-D0D3D4 text-4xl font-bold">0</span></p>
            <!-- Global high score, applies to both games -->
        </div>

        <!-- Game Instructions Section -->
        <div id="gameInstructions" class="p-6 bg-gray-800 rounded-lg shadow-inner border border-gray-700">
            <!-- Instructions will be loaded here by JavaScript -->
        </div>

        <!-- Build Your Phish Mode Content -->
        <div id="buildModeContent" class="build-mode-active">
            <div id="emailBuilder" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                <!-- Categories will be dynamically loaded here -->
            </div>
            <!-- Email Preview for Build Mode -->
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-AB2328 mb-4">Email Preview</h2>
                <div class="email-preview-content bg-gray-700 p-6 rounded-lg shadow-inner" id="buildPhishEmailPreview">
                    <!-- Built email will appear here -->
                    <p class="text-D0D3D4">Select options above to build your email...</p>
                </div>
            </div>
            <div class="flex justify-center mt-8">
                <button id="submitPhishBtn" class="btn-primary">Submit Phish</button>
            </div>
        </div>

        <!-- Spot the Phish Mode Content -->
        <div id="spotModeContent" class="spot-mode-hidden">
            <div class="text-center mb-6">
                <p class="text-xl font-semibold text-D0D3D4">Your Score:</p>
                <p id="phishSpotScoreDisplay" class="text-D0D3D4 text-5xl font-bold">0</p>
            </div>
            <div class="email-preview-content bg-gray-700 p-6 rounded-lg shadow-inner mb-8" id="spotPhishEmailPreview">
                <!-- Generated phishing email will appear here -->
            </div>
            <div class="flex justify-center gap-4">
                <button id="checkPhishBtn" class="btn-primary">Check Phish</button>
                <button id="newPhishBtn" class="btn-primary bg-gray-600 hover:bg-gray-700">New Phish</button>
            </div>
        </div>

        <!-- General Tips Button -->
        <div class="flex justify-center mt-8">
            <button id="generalTipsBtn" class="btn-primary bg-gray-600 hover:bg-gray-700">General Phishing Tips</button>
        </div>

        <!-- Admin Login Button -->
        <div class="flex justify-center mt-4">
            <button id="adminLoginBtn" class="btn-primary bg-gray-600 hover:bg-gray-700">Admin Login</button>
        </div>
    </div>

    <!-- Info Modal (for explanations) -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-AB2328 mb-4">Explanation</h2>
            <div id="modalText" class="text-D0D3D4 leading-relaxed">
                <!-- Explanation content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAdminPasswordModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-AB2328 mb-4">Admin Login</h2>
            <p class="text-D0D3D4 mb-4">Enter admin password:</p>
            <input type="password" id="adminPasswordInput" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-AB2328">
            <button id="submitAdminPasswordBtn" class="btn-primary w-full">Login</button>
            <p id="adminPasswordError" class="text-AB2328 mt-2 hidden">Incorrect password.</p>
        </div>
    </div>

    <!-- Admin Log Modal -->
    <div id="adminLogModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAdminLogModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-AB2328 mb-4">User High Score Log</h2>
            <div id="adminLogContent" class="text-D0D3D4 leading-relaxed max-h-80 overflow-y-auto mb-4">
                <p>Loading user data...</p>
            </div>
            <button id="exportCsvBtn" class="btn-primary bg-gray-600 hover:bg-gray-700 w-full">Export to CSV</button>
        </div>
    </div>

    <!-- General Tips Modal -->
    <div id="generalTipsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeGeneralTipsModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-AB2328 mb-4">General Phishing Prevention Tips</h2>
            <div id="generalTipsText" class="text-D0D3D4 leading-relaxed">
                <ul class="list-disc list-inside space-y-3">
                    <li><strong>Check the Sender's Email Address:</strong> Look for inconsistencies or unusual domains. Phishers often use addresses that look similar to legitimate ones but have subtle differences.</li>
                    <li><strong>Hover Over Links (Don't Click!):</strong> Before clicking, hover your mouse over any links to see the actual URL. If it doesn't match the sender or looks suspicious, don't click.</li>
                    <li><strong>Look for Spelling and Grammar Errors:</strong> Professional organizations rarely send emails with obvious mistakes. These are common red flags in phishing attempts.</li>
                    <li><strong>Be Wary of Urgent or Threatening Language:</strong> Phishing emails often try to create a sense of urgency or fear to pressure you into acting quickly without thinking.</li>
                    <li><strong>Verify Requests for Personal Information:</strong> Legitimate companies will rarely ask for sensitive information (passwords, credit card numbers, etc.) via email. If in doubt, go directly to their official website.</li>
                    <li><strong>Don't Open Suspicious Attachments:</strong> Attachments can contain malware. Only open attachments from trusted senders and if you are expecting them.</li>
                    <li><strong>Use Multi-Factor Authentication (MFA):</strong> MFA adds an extra layer of security to your accounts, making it harder for phishers to gain access even if they steal your password.</li>
                    <li><strong>Keep Software Updated:</strong> Regularly update your operating system, web browser, and security software to protect against known vulnerabilities.</li>
                    <li><strong>Report Suspicious Emails:</strong> If you receive a phishing email, report it to your IT department or email provider, and then delete it.</li>
                    <li><strong>Trust Your Gut:</strong> If an email feels "off" or too good to be true, it probably is.</li>
                </ul>
            </div>
        </div>
    </div >

    <script type="module">
        // Data structure for phishing email categories and options
        const phishingCategories = {
            sender: {
                title: "Sender",
                options: [
                    { value: "legit-company", text: "Legitimate Company (e.g., Google, Microsoft)", score: 10, message: "Looks Official", explanation: "A legitimate-looking sender makes the email seem trustworthy at first glance.", emailContent: "Google Support <support@google.com>" },
                    { value: "generic-support", text: "Generic Support (e.g., 'Support Team', 'Admin')", score: 20, message: "Vague Sender", explanation: "Generic senders are common in phishing as they don't require specific impersonation.", emailContent: "Admin <no-reply@service.net>" },
                    { value: "typo-company", text: "Company with Typo (e.g., 'Googel', 'Micros0ft')", score: 30, message: "Subtle Typo", explanation: "Typos in sender names are a classic phishing tactic to trick hurried recipients.", emailContent: "Micros0ft Security <security@micros0ft.com>" },
                    { value: "random-email", text: "Random Email Address (e.g., 'xyz123@free-mail.com')", score: 5, message: "Obvious Fake", explanation: "An obviously fake sender reduces credibility, but some might still fall for it.", emailContent: "randomuser123@free-mail.com" }
                ]
            },
            subject: {
                title: "Subject Line",
                options: [
                    { value: "invoice-alert", text: "Invoice/Payment Alert (e.g., 'Your Invoice Is Ready')", score: 25, message: "Financial Urgency", explanation: "Subjects related to money often trigger immediate attention and fear of loss.", emailContent: "Action Required: Your Invoice #12345 is Overdue" },
                    { value: "security-alert", text: "Security Alert (e.g., 'Unusual Sign-in Activity')", score: 30, message: "Security Scare", explanation: "Security alerts create panic, leading users to click links to 'secure' their accounts.", emailContent: "Urgent Security Alert: Unusual Sign-in Detected" },
                    { value: "package-delivery", text: "Package Delivery (e.g., 'Your Package is Delayed')", score: 20, message: "Delivery Notification", explanation: "Common and relatable, exploiting anticipation for deliveries.", emailContent: "Delivery Exception: Your Package Has Been Delayed" },
                    { value: "account-suspension", text: "Account Suspension (e.g., 'Your Account Will Be Suspended')", score: 35, message: "Threat of Loss", explanation: "Threatening account suspension pressures users to act without verifying.", emailContent: "Important: Your Account Will Be Suspended Soon" },
                    { value: "prize-win", text: "Prize/Lottery Win (e.g., 'You've Won a Free Gift!')", score: 15, message: "Too Good to Be True", explanation: "Appeals to greed, but often easily identifiable as scams.", emailContent: "Congratulations! You've Won a New iPhone!" }
                ]
            },
            body: {
                title: "Email Body Content",
                options: [
                    { value: "generic-greeting", text: "Generic Greeting ('Dear Customer')", score: 15, message: "Impersonal Greeting", explanation: "Legitimate emails usually address you by name, lack of personalization is a red flag.", emailContent: "Dear Customer, we are writing to inform you about an important update regarding your account." },
                    { value: "urgent-action", text: "Urgent Call to Action ('Click Now to Avoid Closure')", score: 30, message: "High Pressure", explanation: "Creates a sense of urgency, bypassing critical thinking.", emailContent: "We detected unusual activity on your account. To prevent unauthorized access, please verify your details immediately. Failure to act within 24 hours will result in account suspension." },
                    { value: "request-info", text: "Request for Personal Info (e.g., 'Verify Your Password')", score: 40, message: "Info Harvesting", explanation: "Directly asks for sensitive data, a clear sign of phishing.", emailContent: "Please verify your account information (username and password) by clicking the link below. This is required for security purposes." },
                    { value: "poor-grammar", text: "Poor Grammar/Spelling", score: 20, message: "Unprofessional Language", explanation: "Errors indicate a lack of professionalism, common in non-native English speaking scammers.", emailContent: "We have detected a problem with you're account. Please click hear to fix it immediate. Our system will be block your access if you not respond." },
                    { value: "vague-details", text: "Vague Details (e.g., 'a recent transaction')", score: 10, message: "Lack of Specificity", explanation: "Avoids specific details that could be easily disproven.", emailContent: "There was a recent transaction on your account that requires your attention. Please log in to review it at your earliest convenience." }
                ]
            },
            link: {
                title: "Link/Call to Action",
                options: [
                    { value: "shortened-url", text: "Shortened URL (e.g., bit.ly/abc)", score: 25, message: "Hidden Destination", explanation: "Masks the true destination, preventing users from seeing a malicious URL.", emailContent: "bit.ly/secure-login" },
                    { value: "typo-domain", text: "Typo in Domain (e.g., 'gooogle.com' instead of 'google.com')", score: 30, message: "Lookalike Domain", explanation: "Visually similar to legitimate domains, easily missed.", emailContent: "https://www.gooogle.com/signin" },
                    { value: "ip-address", text: "IP Address Link (e.g., http://192.168.1.1)", score: 20, message: "Direct IP Link", explanation: "Unusual for legitimate sites, often used by attackers.", emailContent: "http://192.168.1.1/login" },
                    { value: "embedded-button", text: "Button with Malicious Link (e.g., 'Verify Account' button)", score: 35, message: "Deceptive Button", explanation: "Appears harmless but leads to a phishing site.", emailContent: `<button style="background-color:#AB2328; color:white; padding:10px 20px; border-radius:5px; border:none; cursor:pointer;">Verify Account</button>` },
                    { value: "no-link", text: "No Link (Just Text)", score: 0, message: "No Direct Threat", explanation: "No link means no direct phishing vector, but could be a precursor.", emailContent: "No direct link provided in this email." }
                ]
            }
        };

        // State variables
        let selectedOptions = {};
        let currentPhishScore = 0;
        let currentMode = 'build'; // 'build' or 'spot'
        let spotPhishScore = 0;
        let identifiedPhishElements = new Set();
        let currentSpotPhishData = null; // Stores the data for the current 'Spot the Phish' email

        // DOM Elements
        const emailBuilder = document.getElementById('emailBuilder');
        const submitPhishBtn = document.getElementById('submitPhishBtn');
        const infoModal = document.getElementById('infoModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalText = document.getElementById('modalText');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const buildModeBtn = document.getElementById('buildModeBtn');
        const spotModeBtn = document.getElementById('spotModeBtn');
        const buildModeContent = document.getElementById('buildModeContent');
        const spotModeContent = document.getElementById('spotModeContent');
        const spotPhishEmailPreview = document.getElementById('spotPhishEmailPreview');
        const buildPhishEmailPreview = document.getElementById('buildPhishEmailPreview');
        const phishSpotScoreDisplay = document.getElementById('phishSpotScoreDisplay');
        const checkPhishBtn = document.getElementById('checkPhishBtn');
        const newPhishBtn = document.getElementById('newPhishBtn');
        const generalTipsBtn = document.getElementById('generalTipsBtn');
        const generalTipsModal = document.getElementById('generalTipsModal');
        const closeGeneralTipsModalBtn = document.getElementById('closeGeneralTipsModalBtn');
        const gameInstructions = document.getElementById('gameInstructions');
        const adminLoginBtn = document.getElementById('adminLoginBtn'); // New Admin button
        const adminPasswordModal = document.getElementById('adminPasswordModal'); // New Admin Password Modal
        const closeAdminPasswordModalBtn = document.getElementById('closeAdminPasswordModalBtn');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const submitAdminPasswordBtn = document.getElementById('submitAdminPasswordBtn');
        const adminPasswordError = document.getElementById('adminPasswordError');
        const adminLogModal = document.getElementById('adminLogModal'); // New Admin Log Modal
        const closeAdminLogModalBtn = document.getElementById('closeAdminLogModalBtn');
        const adminLogContent = document.getElementById('adminLogContent');
        const exportCsvBtn = document.getElementById('exportCsvBtn'); // New Export CSV button

        // Instruction content
        const buildModeInstructions = `
            <p class="text-D0D3D4 mb-4"><strong>Instructions for Build Your Phish:</strong></p>
            <ul class="list-disc list-inside text-D0D3D4 space-y-2">
                <li>Select options from each category (Sender, Subject, Body, Link) to construct your phishing email.</li>
                <li>Your goal is to create the most convincing and effective phishing email.</li>
                <li>The higher the 'Phish Score', the more deceptive your email is.</li>
                <li>Click "Submit Phish" to see your score and an explanation of why certain elements are effective.</li>
            </ul>
        `;

        const spotModeInstructions = `
            <p class="text-D0D3D4 mb-4"><strong>Instructions for Spot the Phish:</strong></p>
            <ul class="list-disc list-inside text-D0D3D4 space-y-2">
                <li>An email will be generated for you. Your task is to identify all the phishing indicators.</li>
                <li>Click on any word, phrase, or element within the email preview that you believe is a phishing attempt.</li>
                <li>You get points for correctly identifying phishing elements. Be careful, incorrect guesses might deduct points!</li>
                <li>Click "Check Phish" when you think you've found all the indicators.</li>
                <li>Click "New Phish" to generate a new email and start over.</li>
            </ul>
        `;

        // Function to update high score display
        function updateHighScoreDisplay() {
            highScoreDisplay.textContent = window.highScore; // Use window.highScore
            // Also update in Firestore if Firebase is ready
            if (window.db && window.currentUserId) {
                window.updateHighScoreInFirestore(currentMode); // Pass currentMode
            }
        }

        // Function to render categories and options for Build Mode
        function renderEmailBuilder() {
            emailBuilder.innerHTML = ''; // Clear previous content
            for (const categoryKey in phishingCategories) {
                const category = phishingCategories[categoryKey];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-selection bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600'; /* Adjusted grey */
                categoryDiv.innerHTML = `
                    <h3 class="text-2xl font-semibold text-AB2328 mb-4">${category.title}</h3>
                    <div class="email-part-options">
                        ${category.options.map(option => `
                            <button class="email-part-option bg-gray-600 hover:bg-gray-500 text-left p-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-AB2328"
                                data-category="${categoryKey}" data-value="${option.value}" data-score="${option.score}">
                                ${option.text}
                            </button>
                        `).join('')}
                    </div>
                `;
                emailBuilder.appendChild(categoryDiv);
            }

            // Add event listeners for option selection
            document.querySelectorAll('.email-part-option').forEach(button => {
                button.addEventListener('click', (event) => {
                    const category = event.target.dataset.category;
                    const value = event.target.dataset.value;

                    // Deselect previous option in the same category
                    document.querySelectorAll(`.email-part-option[data-category="${category}"]`).forEach(btn => {
                        btn.classList.remove('selected');
                    });

                    // Select current option
                    event.target.classList.add('selected');
                    selectedOptions[category] = value;
                    updateBuildPhishPreview(); // Update preview when an option is selected
                });
            });

            // Initialize selected options (optional, can be empty)
            for (const categoryKey in phishingCategories) {
                const firstOption = phishingCategories[categoryKey].options[0];
                if (firstOption) {
                    selectedOptions[categoryKey] = firstOption.value;
                    // Visually select the first option
                    const btn = document.querySelector(`.email-part-option[data-category="${categoryKey}"][data-value="${firstOption.value}"]`);
                    if (btn) btn.classList.add('selected');
                }
            }
            updateBuildPhishPreview(); // Initial preview render
        }

        // Function to update the email preview in Build Mode
        function updateBuildPhishPreview() {
            let previewHtml = '';
            const senderOption = phishingCategories.sender.options.find(opt => opt.value === selectedOptions.sender);
            const subjectOption = phishingCategories.subject.options.find(opt => opt.value === selectedOptions.subject);
            const bodyOption = phishingCategories.body.options.find(opt => opt.value === selectedOptions.body);
            const linkOption = phishingCategories.link.options.find(opt => opt.value === selectedOptions.link);

            if (senderOption) {
                previewHtml += `<p><strong>From:</strong> ${senderOption.emailContent}</p>`;
            }
            if (subjectOption) {
                previewHtml += `<p><strong>Subject:</strong> ${subjectOption.emailContent}</p>`;
            }
            previewHtml += `<hr class="my-4 border-gray-600">`;
            if (bodyOption) {
                previewHtml += `<p class="mb-4">${bodyOption.emailContent}</p>`;
            }

            if (linkOption) {
                if (linkOption.value === "embedded-button") {
                    previewHtml += `<p class="mb-4">Please click here to proceed: ${linkOption.emailContent}</p>`;
                } else if (linkOption.value !== "no-link") {
                    previewHtml += `<p class="mb-4">Please click here to proceed: <a href="#" class="text-AB2328 hover:underline">${linkOption.emailContent}</a></p>`;
                } else {
                    previewHtml += `<p class="mb-4">${linkOption.emailContent}</p>`;
                }
            }

            previewHtml += `<p>Thank you,</p><p>The Support Team</p>`;

            buildPhishEmailPreview.innerHTML = previewHtml;
        }


        // Function to calculate and display phish score for Build Your Phish
        function calculatePhishScore() {
            currentPhishScore = 0;
            let explanationsHtml = '';

            for (const categoryKey in selectedOptions) {
                const selectedValue = selectedOptions[categoryKey];
                const categoryData = phishingCategories[categoryKey];
                const option = categoryData.options.find(opt => opt.value === selectedValue);

                if (option) {
                    currentPhishScore += option.score;
                    explanationsHtml += `<p><strong>${categoryData.title}: ${option.message}</strong><br>${option.explanation}</p>`;
                }
            }

            // Update high score if current score is higher
            if (currentPhishScore > window.highScore) { // Use window.highScore
                window.highScore = currentPhishScore; // Update window.highScore
                localStorage.setItem('phishcraftHighScore', window.highScore);
                updateHighScoreDisplay(); // This will also trigger Firestore update, passing 'build' mode
            }

            // Set the modal text, including the score for Build Your Phish mode
            modalText.innerHTML = `
                <p class="text-xl font-bold text-center mb-4">Your Phish Score: <span class="text-AB2328">${currentPhishScore}</span></p>
                <h3 class="text-2xl font-semibold text-AB2328 mb-3">Breakdown:</h3>
                ${explanationsHtml || '<p>No specific explanation available for this category.</p>'}
            `;
            infoModal.classList.add('show');
        }

        // Function to switch between modes
        function switchMode(mode) {
            currentMode = mode;
            buildModeBtn.classList.remove('active');
            spotModeBtn.classList.remove('active');
            buildModeContent.classList.add('spot-mode-hidden');
            spotModeContent.classList.add('spot-mode-hidden');
            spotPhishEmailPreview.classList.remove('spot-mode'); // Remove spot-mode class when switching away

            if (mode === 'build') {
                buildModeBtn.classList.add('active');
                buildModeContent.classList.remove('spot-mode-hidden');
                gameInstructions.innerHTML = buildModeInstructions;
                renderEmailBuilder(); // Re-render to ensure selections are visible and update preview
            } else if (mode === 'spot') {
                spotModeBtn.classList.add('active');
                spotModeContent.classList.remove('spot-mode-hidden');
                gameInstructions.innerHTML = spotModeInstructions;
                generateSpotPhishEmail(); // Generate a new email for Spot the Phish mode
                spotPhishEmailPreview.classList.add('spot-mode'); // Add spot-mode class for styling clickable elements
            }
        }

        // Function to generate a random phishing email for Spot the Phish mode
        function generateSpotPhishEmail() {
            identifiedPhishElements.clear(); // Reset identified elements
            spotPhishScore = 0;
            phishSpotScoreDisplay.textContent = spotPhishScore;
            spotPhishEmailPreview.innerHTML = ''; // Clear previous email

            const selectedSpotOptions = {};
            let emailHtml = '';

            // Randomly select one option from each category
            for (const categoryKey in phishingCategories) {
                const options = phishingCategories[categoryKey].options;
                // Ensure we don't pick 'no-link' for the link category if we want a clickable element
                let randomIndex;
                if (categoryKey === 'link') {
                    // Pick any link option except 'no-link' for the main clickable element
                    const clickableLinkOptions = options.filter(opt => opt.value !== 'no-link');
                    // If no clickable links, fall back to any link
                    if (clickableLinkOptions.length > 0) {
                        randomIndex = Math.floor(Math.random() * clickableLinkOptions.length);
                        selectedSpotOptions[categoryKey] = clickableLinkOptions[randomIndex];
                    } else {
                        randomIndex = Math.floor(Math.random() * options.length);
                        selectedSpotOptions[categoryKey] = options[randomIndex];
                    }
                } else {
                    randomIndex = Math.floor(Math.random() * options.length);
                    selectedSpotOptions[categoryKey] = options[randomIndex];
                }
            }

            currentSpotPhishData = selectedSpotOptions; // Store for checking

            // Construct the email content with clickable elements
            // Sender
            emailHtml += `<p><strong>From:</strong> <span class="clickable-phish-element" data-category="sender" data-value="${selectedSpotOptions.sender.value}">${selectedSpotOptions.sender.emailContent}</span></p>`;
            // Subject
            emailHtml += `<p><strong>Subject:</strong> <span class="clickable-phish-element" data-category="subject" data-value="${selectedSpotOptions.subject.value}">${selectedSpotOptions.subject.emailContent}</span></p>`;
            emailHtml += `<hr class="my-4 border-gray-600">`;

            // Body
            emailHtml += `<p class="mb-4"><span class="clickable-phish-element" data-category="body" data-value="${selectedSpotOptions.body.value}">${selectedSpotOptions.body.emailContent}</span></p>`;

            // Link/Call to Action - integrate dynamically based on selected link type
            let linkElementHtml = '';
            if (selectedSpotOptions.link.value === "embedded-button") {
                linkElementHtml = `<span class="clickable-phish-element" data-category="link" data-value="${selectedSpotOptions.link.value}">${selectedSpotOptions.link.emailContent}</span>`;
            } else if (selectedSpotOptions.link.value !== "no-link") {
                linkElementHtml = `<a href="#" class="text-AB2328 hover:underline clickable-phish-element" data-category="link" data-value="${selectedSpotOptions.link.value}">${selectedSpotOptions.link.emailContent}</a>`;
            } else {
                 linkElementHtml = selectedSpotOptions.link.emailContent; // Just text if no-link
            }
            emailHtml += `<p class="mb-4">Please click here to proceed: ${linkElementHtml}</p>`;

            // Add a closing remark, potentially with another clickable element for sender context
            emailHtml += `<p>Thank you,</p><p>The <span class="clickable-phish-element" data-category="sender" data-value="${selectedSpotOptions.sender.value}">Support Team</span></p>`;


            spotPhishEmailPreview.innerHTML = emailHtml;

            // Add click listeners to the generated email elements
            document.querySelectorAll('#spotPhishEmailPreview .clickable-phish-element').forEach(element => {
                element.addEventListener('click', (event) => {
                    const category = event.target.dataset.category;
                    const value = event.target.dataset.value;
                    const key = `${category}-${value}`;

                    if (!identifiedPhishElements.has(key)) {
                        const option = phishingCategories[category].options.find(opt => opt.value === value);
                        // Only add score if the element is actually a phishing indicator (score > 0)
                        if (option && option.score > 0) {
                            spotPhishScore += option.score;
                            phishSpotScoreDisplay.textContent = spotPhishScore;
                            identifiedPhishElements.add(key);
                            event.target.classList.add('identified'); // Mark as identified
                        } else {
                            // Optional: Deduct points for incorrect guesses
                            // spotPhishScore = Math.max(0, spotPhishScore - 5);
                            // phishSpotScoreDisplay.textContent = spotPhishScore;
                            // console.log("Incorrect guess, no points added.");
                        }
                    }
                });
            });
        }

        // Function to check the Spot the Phish score
        function checkSpotPhish() {
            let totalPossibleScore = 0;
            let identifiedCount = 0;
            let explanationsHtml = '';

            for (const categoryKey in currentSpotPhishData) {
                const option = currentSpotPhishData[categoryKey];
                if (option.score > 0) { // Only count actual phishing elements
                    totalPossibleScore += option.score;
                    const key = `${categoryKey}-${option.value}`;
                    if (identifiedPhishElements.has(key)) {
                        identifiedCount++;
                        explanationsHtml += `<p><strong>Identified: ${phishingCategories[categoryKey].title} - ${option.message}</strong><br>${option.explanation}</p>`;
                    } else {
                        explanationsHtml += `<p class="text-AB2328"><strong>Missed: ${phishingCategories[categoryKey].title} - ${option.message}</strong><br>${option.explanation}</p>`;
                    }
                }
            }

            modalText.innerHTML = `
                <p class="text-xl font-bold text-center mb-4">Your Spot Phish Score: <span class="text-AB2328">${spotPhishScore}</span> / ${totalPossibleScore}</p>
                <p class="text-center mb-4">${identifiedCount} out of ${Object.values(currentSpotPhishData).filter(opt => opt.score > 0).length} phishing elements identified.</p>
                <h3 class="text-2xl font-semibold text-AB2328 mb-3">Review:</h3>
                ${explanationsHtml || '<p>No specific explanation available for this email.</p>'}
            `;
            infoModal.classList.add('show');

            // Update high score for Spot the Phish if applicable
            if (spotPhishScore > window.highScore) { // Use window.highScore
                window.highScore = spotPhishScore; // Update window.highScore
                localStorage.setItem('phishcraftHighScore', window.highScore);
                updateHighScoreDisplay(); // This will also trigger Firestore update, passing 'spot' mode
            }
        }


        // Event Listeners
        submitPhishBtn.addEventListener('click', calculatePhishScore);
        closeModalBtn.addEventListener('click', () => {
            infoModal.classList.remove('show');
        });
        window.addEventListener('click', (event) => {
            if (event.target === infoModal) {
                infoModal.classList.remove('show');
            }
        });

        // Mode switching event listeners
        buildModeBtn.addEventListener('click', () => switchMode('build'));
        spotModeBtn.addEventListener('click', () => switchMode('spot'));

        // Spot the Phish mode buttons
        checkPhishBtn.addEventListener('click', checkSpotPhish);
        newPhishBtn.addEventListener('click', generateSpotPhishEmail);

        // General Tips Modal logic
        generalTipsBtn.addEventListener('click', () => {
            generalTipsModal.classList.add('show');
        });

        closeGeneralTipsModalBtn.addEventListener('click', () => {
            generalTipsModal.classList.remove('show');
        });

        window.addEventListener('click', (event) => {
            if (event.target === generalTipsModal) {
                generalTipsModal.classList.remove('show');
            }
        });

        // Admin Login Logic
        adminLoginBtn.addEventListener('click', () => {
            adminPasswordInput.value = ''; // Clear input
            adminPasswordError.classList.add('hidden'); // Hide error
            adminPasswordModal.classList.add('show');
        });

        closeAdminPasswordModalBtn.addEventListener('click', () => {
            adminPasswordModal.classList.remove('show');
        });

        window.addEventListener('click', (event) => {
            if (event.target === adminPasswordModal) {
                adminPasswordModal.classList.remove('show');
            }
        });

        submitAdminPasswordBtn.addEventListener('click', async () => {
            const password = adminPasswordInput.value;
            if (password === 'PAC365') {
                adminPasswordModal.classList.remove('show');
                await displayAdminLog();
                adminLogModal.classList.add('show');
            } else {
                adminPasswordError.classList.remove('hidden');
            }
        });

        closeAdminLogModalBtn.addEventListener('click', () => {
            adminLogModal.classList.remove('show');
        });

        window.addEventListener('click', (event) => {
            if (event.target === adminLogModal) {
                adminLogModal.classList.remove('show');
            }
        });

        async function displayAdminLog() {
            adminLogContent.innerHTML = '<p>Loading user data...</p>';
            const userScores = await window.fetchAllUserScores(); // Call the global function

            if (userScores.length === 0) {
                adminLogContent.innerHTML = '<p>No user data available yet.</p>';
                return;
            }

            let logHtml = `<table class="min-w-full bg-gray-800 rounded-lg overflow-hidden">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="py-2 px-4 text-left text-AB2328">User ID</th>
                        <th class="py-2 px-4 text-left text-AB2328">High Score</th>
                        <th class="py-2 px-4 text-left text-AB2328">Game Mode</th>
                        <th class="py-2 px-4 text-left text-AB2328">Last Updated</th>
                    </tr>
                </thead>
                <tbody>`;

            userScores.sort((a, b) => b.highScore - a.highScore); // Sort by high score descending

            userScores.forEach(user => {
                const lastUpdatedDate = user.lastUpdated ? new Date(user.lastUpdated).toLocaleString() : 'N/A';
                logHtml += `
                    <tr class="border-b border-gray-600">
                        <td class="py-2 px-4">${user.userId}</td>
                        <td class="py-2 px-4">${user.highScore}</td>
                        <td class="py-2 px-4">${user.gameMode || 'N/A'}</td> <!-- Display game mode -->
                        <td class="py-2 px-4">${lastUpdatedDate}</td>
                    </tr>
                `;
            });

            logHtml += `</tbody></table>`;
            adminLogContent.innerHTML = logHtml;
        }

        // Function to export admin log to CSV
        exportCsvBtn.addEventListener('click', async () => {
            const userScores = await window.fetchAllUserScores(); // Get the latest data

            if (userScores.length === 0) {
                // You could show a message here if there's no data to export
                console.warn("No data to export to CSV.");
                return;
            }

            // Define CSV headers
            const headers = ["User ID", "High Score", "Game Mode", "Last Updated"];
            let csvContent = headers.join(",") + "\n";

            // Add data rows
            userScores.forEach(user => {
                const lastUpdatedDate = user.lastUpdated ? new Date(user.lastUpdated).toLocaleString() : 'N/A';
                const row = [
                    `"${user.userId}"`, // Enclose userId in quotes to handle potential commas
                    user.highScore,
                    `"${user.gameMode || 'N/A'}"`, // Enclose gameMode in quotes
                    `"${lastUpdatedDate}"` // Enclose date in quotes
                ];
                csvContent += row.join(",") + "\n";
            });

            // Create a Blob and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "phishcraft_user_scores.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // Fallback for browsers that don't support the download attribute
                console.error("Your browser does not support the download attribute. Please right-click and save the content.");
                // You might open a new window with the CSV content here for manual copy
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            }
        });


        // Initial setup on load
        window.onload = function() {
            updateHighScoreDisplay();
            switchMode('build'); // Start in 'Build Your Phish' mode
        };
    </script>
</body>
</html>
